<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Info for developers</title>
  </head>
  <body>
    <div id="wiki-content">
      <div class="wrap">
      <div id="wiki-body" class="gollum-markdown-content instapaper_body">
        <div class="markdown-body">
          <p>How to accept unhosted accounts in your web app:</p>

    <p>See also the API spec: <a href="https://github.com/unhosted/website/wiki/API-0.4">https://github.com/unhosted/website/wiki/API-0.4</a></p>

    <p>We provide a client-side library called remoteStorage.js, which you can use to easily make your web app compatible with unhosted accounts. The first thing you do is include it. We use require.js, so the script you need to include in your page's head will look roughly as follows (assuming version number 0.4.2):</p>

    <pre><code>&lt;script src="http://unhosted.org/require.js"&gt;&lt;/script&gt;
    &lt;script&gt;
      require(['http://unhosted.org/remoteStorage-0.4.2.js'], function(remoteStorage) {

        //do stuff with remoteStorage...

      });
    &lt;/script&gt;
    </code></pre>

    <p>You can also host require.js yourself, and you can host the <a href="https://github.com/unhosted/remoteStorage.js">library</a> yourself too if you prefer.</p>

    <p>The next step is to look up whether a user has remote storage linked to their user address. This is done with the getStorageInfo function. It takes a user address ('user@host') and a callback as its arguments. The callback will get an error code, and a storageInfo object. If the error code is null, then the storageInfo object will have some data fields in it that we will need later. It looks as follows:</p>

    <pre><code>  function connect() {
        var userAddress=document.getElementById('userAddress').value;
        remoteStorage.getStorageInfo(userAddress, function(err, storageInfo) {
          if(err) {
            alert('no, sorry!');
          } else {
            alert('yes! look: '+JSON.stringify(storageInfo));
            localStorage.currUserStorageInfo = JSON.stringify(storageInfo);
          }
        });
      }
    </code></pre>

    <p>The next step is to get some public information from someone's remote storage. We use the createClient method to create a client, and on there call the get method to retrieve the information we want:</p>

    <pre><code>function getPublicFoo(userAddress, cb) {
      remoteStorage.getStorageInfo(userAddress, function(err, storageInfo) {
        if(err) {
          alert('could not find the remote storage of '+userAddress);
        } else {
          var client = remoteStorage.createClient(storageInfo, 'public');
          client.get('foo', function(err, data) {
            if(err) {
              alert('could not find foo on the remote storage of '+userAddress);
            } else {
              cb(data);    
            }
          });
        }
      });
    }
    </code></pre>

    <p>Getting public data is easy because it requires no credentials. If we want to write to a user's public data, or read or write from one of the other categories, we need to do an OAuth dialog first, and obtain a token. Our library provides two functions to make this easier. On our main page, we add the following code to open the popup window. Say we want to connect to the user's "contacts" and "pictures" categories, and have set up a token receiver (see below) on <a href="https://myfavouritesandwich.org/rcvToken.html:">https://myfavouritesandwich.org/rcvToken.html:</a></p>

    <pre><code>function doOAuth() {
      var receiverPage = 'https://myfavouritesandwich.org/rcvToken.html';
      var oauthPage = remoteStorage.makeOAuthAddress(localStorage.currUserStorageInfo, ['public', 'pictures'], receiverPage);
      var popup = window.open(oauthPage);
      //when the popup closes, if the OAuth dance was successful,
      //localStorage.bearerToken will have been populated
    }
    </code></pre>

    <p>With the bearerToken, you can create clients with credentials, and use the get, put and delete methods on there, for instance:</p>

    <pre><code>function publishAvatar() {
      var publicClient = remoteStorage.createClient(storageInfo, 'public', localStorage.bearerToken);
      var picturesClient = remoteStorage.createClient(storageInfo, 'pictures', localStorage.bearerToken);
      picturesClient.get('foto01', function(err, data) {
        publicClient.put('avatar', data, function(err, data2) {
          alert('copied //user@host/pictures#foto01 to //user@host/public#avatar');
        });
      });
    }
    </code></pre>

    <p>And then on /rcvToken.html we would need the following:</p>

    <pre><code>localStorage.bearerToken = remoteStorage.receiveToken();
    window.close();
    </code></pre>

    <p>Putting this all together, the resulting pages are on <a href="https://myfavouritesandwich.org/tutorial.html">https://myfavouritesandwich.org/tutorial.html</a> 
    and the helper page on <a href="https://myfavouritesandwich.org/rcvToken.html">https://myfavouritesandwich.org/rcvToken.html</a>.</p>
        </div>
      </div>
      </div>

    </div>    
  </body>
</html>
